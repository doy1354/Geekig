{% extends 'profile/profile_base.html' %}
{% load static widget_tweaks %}
{% block title_text %}Profile{% endblock %}
{% load static %}
{% block extra_search_form %}
   {% include 'snippets/search_form.html' %}
{% endblock %}

{% block profile %}


<div class="page-title-box d-flex align-items-center justify-content-between gap-3">
    <h4 class="mb-sm-0" data-i18n="My Bank Account">My Bank Account</h4>
    <div class="page-title-right w-auto">
        <a href="#" class="btn btn-dark text-uppercase" did="add-bank" data-bs-toggle="modal" data-bs-target="#userBank" data-i18n="new_bank">
            <i class="ri-add-line align-middle fs-lg me-2"></i> New Bank
        </a>
    </div>
</div>
{% if my_bank %}
<div class="card">
    <div class="card-body table-responsive p-0">
        {% if update %}
        <table id="bpl-compte" class="table nowrap align-middle" style="width:100%">
            <thead>
                <tr>
                    <th data-ordering="false" class="text-uppercase" data-i18n="Bank Name">Bank Name</th>
                    <th data-ordering="false" class="text-uppercase" data-i18n="status">Status</th>
                    <th data-ordering="false" class="text-uppercase" data-i18n="iban">IBAN</th>
                    <th data-ordering="false" class="text-uppercase" data-i18n="bic">BIC
                    </th>
                    <th class="text-uppercase" data-i18n="action">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for obj in my_bank %}
                <tr>
                    <td>{{ obj.bank_line.last.name }}</td>
                    <td>{% if obj.is_active %}<span class="badge bg-warning-subtle  text-success">Connected</span>
                        {% else %}<span class="badge bg-warning-subtle  text-danger">Disconnected</span>{% endif %}</td>
                    <td>{% if obj.bank_line.last.iban %}{{ obj.bank_line.last.iban }}{% endif %}</td>
                    <td>{% if obj.bank_line.last.bic %}{{ obj.bank_line.last.bic }}{% endif %}</td>
                    <th>

                        <button type="button" class="btn p-0" style="font-size: 20px;" data-bs-toggle="modal"
                            data-bs-target="#exampleModal{{ forloop.counter }}" title="Update">
                            <i class="ri-pencil-fill"></i>
                        </button>
                        {% if obj.is_active is False %}

                        <button class="btn p-0 reconnect" style="font-size: 20px;" type="button" value="{{ obj.bank_id }}"
                            style="padding: 2px 10px;">
                            <i class="ri-links-fill fs-3"></i>
                        </button>
                        {% endif %}
                        {% if not obj.bank_line.all %}
                        <button id="connect" type="button" value="{{ obj.institution_id }}" style="
                        border: 2px solid #000;
                        padding: 1px 3px;
                        border-radius: 50%;
                        font-size: 14px;">
                            <i class="ri-links-fill fs-3"></i>
                        </button>
                        {% endif %}
                        {% if obj.is_active %}
                        <button id="disconnected" type="button" title="Delete" value="{{ obj.bank_id }}" class="btn p-0" style="font-size: 20px;">
                            <i class="ri-delete-bin-fill"></i>
                        </button>
                        {% endif %}


                        <!-- Modal -->
                        <div class="modal fade" id="exampleModal{{ forloop.counter }}" tabindex="-1"
                            aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title text-white" id="exampleModalLabel" data-i18n="Modal title">Modal title</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <form method="post">
                                        <div class="modal-body">

                                            {% csrf_token %}
                                            <div class="modal-body text-start">
                                                <div class="row">
                                                    <div class="col-md-12 mb-3">
                                                        <label for="" data-i18n="Bank Name">Bank Name</label>
                                                        <input type="text" class="form-control border" name="bank_name"
                                                            value="{% if obj.bank_line.last.name %}{{ obj.bank_line.last.name }}{% endif %}">
                                                    </div>
                                                    <div class="col-md-12 mb-3">
                                                        <label for="" data-i18n="iban">IBAN</label>
                                                        <input type="text" class="form-control border" name="iban"
                                                            value="{% if obj.bank_line.last.iban %}{{ obj.bank_line.last.iban }}{% endif %}">
                                                    </div>
                                                    <div class="col-md-12 mb-3">
                                                        <label for=""data-i18n="bic">BIC</label>
                                                        <input type="text" class="form-control border" name="bic"
                                                            value="{% if obj.bank_line.last.bic %}{{ obj.bank_line.last.bic }}{% endif %}">
                                                    </div>
                                                    <div class="col-md-12 mb-3">
                                                        <label for="" data-i18n="Primary Bank">Primary Bank</label>
                                                        <input type="checkbox" name="is_primary"
                                                        {% if obj.bank_line.last.is_primary %}
                                                            checked
                                                            {% endif %}
                                                            >
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-outline-dark"
                                                data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-dark" value="{{ obj.pk }}"
                                                name="update">Update</button>
                                    </form>
                                </div>
                            </div>
                        </div>
    </div>

    </th>
    </tr>
    {% endfor %}
    </tbody>
    </table>
    {% endif %}
</div>
</div>
{% endif %}


<div class="modal fade" id="userBank" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-6 d-flex align-items-center gap-2 text-white" id="exampleModalLabel" data-i18n="Find your Bank">Find your Bank<i class="ri-question-fill fs-4 text-white"></i></h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="GET" accept-charset="UTF-8">
                <div class="px-5 pt-4">
                    <div class="row">
                        <div class="col-lg-6">
                                <select name="country" id="country" class="form-control border mb-2">
                                    <option value="GB">GB</option>
                                    <option value="NO">Norway</option>
                                    <option value="SE">Sweden</option>
                                    <option value="FI">Finland</option>
                                    <option value="DK">Denmark</option>
                                    <option value="EE">Estonia</option>
                                    <option value="LV">Latvia</option>
                                    <option value="LT">Lithuania</option>
                                    <option value="NL">Netherlands</option>
                                    <option value="CZ">Czechia</option>
                                    <option value="ES">Spain</option>
                                    <option value="PL">Poland</option>
                                    <option value="BE">Belgium</option>
                                    <option value="AT">Austria</option>
                                    <option value="BG">Bulgaria</option>
                                    <option value="HR">Croatia</option>
                                    <option value="CY">Cyprus</option>
                                    <option value="FR">France</option>
                                    <option value="GR">Greece</option>
                                    <option value="HU">Hungary</option>
                                    <option value="IS">Iceland</option>
                                    <option value="IE">Ireland</option>
                                    <option value="IT">Italy</option>
                                    <option value="LI">Liechtenstein</option>
                                    <option value="LU">Luxembourg</option>
                                    <option value="MT">Malta</option>
                                    <option value="PT">Portugal</option>
                                    <option value="RO">Romania</option>
                                    <option value="SK">Slovakia</option>
                                    <option value="SI">Slovenia</option>
                                    <option value="DE">Germany</option>
                                </select>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group app-search p-0">
                                <div class="position-relative">
                                    <input type="text" class="form-control w-100" placeholder="Search..." autocomplete="off" id="searchOptions" value="" />
                                    <span class="ri-search-line search-widget-icon"></span>
                                    <span class="mdi mdi-close-circle search-widget-icon search-widget-icon-close d-none" id="search-close-options"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table bg-white" id="examples">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>
                                        Logo
                                    </th>
                                    <th data-i18n="Bank Name">
                                        Bank Name
                                    </th>
                                    <th>
                                        Country Name
                                    </th>
                                    <th data-i18n="actions">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for obj in all_bank %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td><img style="width: 50px;" src="{{ obj.logo }}" alt=""></td>
                                    <td>{{ obj.name }}</td>
                                    <td>{{ obj.countries.0 }}</td>
                                    <td>
                                        <button class="btn badge bg-success-subtle text-success px-3" type="button" value="{{ obj.id }}"
                                            style="padding: 2px 10px;">Connect</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <button type="submit" id="submit" style="display: none;">submit</button>
            </form>
        </div>
    </div>
</div>

{% endblock profile %}

{% block extra_js %}
<script src="{% static 'js/translation.js' %}"></script>
<script>
    $(document).ready(function() {
      var dataTable = $('#bpl-compte').DataTable();
      $('#search-options').on('keyup', function() {
        dataTable.search($(this).val()).draw();
      });

        $(".text-success").click(function () {
            var value = $(this).val();
            var url = "{% url 'core:selected_bank' %}"
            $.ajax({
                url: url,
                data: {
                    'value': value,
                },
                success: function (data) {
                    if (data == "selected") {
                        window.location.replace(data);
                    }
                    window.location.replace(data);
                },
            });
        });
        $("#country").change(function () {
            $('#submit').click();
        });

        var search = window.location.search;
        if (search.includes("?country")) {
            // userBank modal popup window
            $('#userBank').modal('show');
            var val = search.split('=');
            $('#country').val(val[1]);
        }

        $('#searchOptions').keyup(function(){
            var searchText = $(this).val().toLowerCase();
            $('#examples tbody tr').each(function(){
                var rowText = $(this).text().toLowerCase();
                if(rowText.indexOf(searchText) === -1){
                    $(this).hide();
                } else {
                    $(this).show();
                }
            });
        });
    });
</script>
<script>

    $(document).ready(function () {
        $(".btn-success").click(function () {
            var value = $(this).val();
            var url = "{% url 'core:selected_bank' %}"
            $.ajax({
                url: url,
                data: {
                    'value': value,
                },
                success: function (data) {
                    var url = window.location.href;
                    window.location.replace(url);
                },
            });
        });

        $("#connect").click(function () {
            var value = $(this).val();
            var url = "{% url 'core:selected_bank' %}"
            $.ajax({
                url: url,
                data: {
                    'value': value,
                    'connect': 1,
                },
                success: function (data) {
                    var url = window.location.href;
                    window.location.replace(url);
                },
            });
        });


        $("#disconnected").click(function () {
            var value = $(this).val();
            var url = "{% url 'core:delete_bank' %}"
            $.ajax({
                url: url,
                data: {
                    'value': value,
                },
                success: function (data) {
                    // current URL
                    var url = window.location.href;
                    window.location.replace(url);
                },
            });
        });


        $(".reconnect").click(function () {
            var value = $(this).val();
            var url = "{% url 'core:reconnect_bank' %}"
            $.ajax({
                url: url,
                data: {
                    'value': value,
                },
                success: function (data) {
                    var url = window.location.href;
                    window.location.replace(url);
                },
            });
        });

         
        // $("#country").
        // The value you want to match
        var valueToMatch = "{{ country }}";

        // Find the option with the specified value
        var matchingOption = $('#country option[value="' + valueToMatch + '"]');

        // Check if the option exists
        if (matchingOption.length > 0) {
            // Select the matching option
            matchingOption.prop('selected', true);
        } else {
            console.log("Option with value " + valueToMatch + " not found");
        }
    })
</script>
{% endblock %}